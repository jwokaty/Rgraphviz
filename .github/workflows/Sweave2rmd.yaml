# Workflow derived from https://github.com/r-lib/actions/tree/v2/examples
# Need help debugging build failures? Start at https://github.com/r-lib/actions#where-to-find-help
on:
  push:
    branches: [main]
  workflow_dispatch:

name: Sweave2rmd

jobs:
  fetch-check-repo:
    runs-on: ubuntu-latest
    container: bioconductor/bioconductor_docker:devel
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      R_KEEP_PKG_SOURCE: yes
      REPO_NAME: ${{ github.event.repository.name }}
    steps:
      - uses: actions/checkout@v3
     # - name: create repo
     #  run: |
     #     echo $REPO_NAME
     #     git clone "https://git.bioconductor.org/packages/$REPO_NAME"
     #    rm -rf $REPO_NAME/.git*
     #     mv $REPO_NAME/* .
     #     rm -rf $REPO_NAME
     # - uses: r-lib/actions/setup-r@v2
     #   with:
     #     use-public-rspm: true
     # - uses: r-lib/actions/setup-r-dependencies@v2
     #  with:
     #    extra-packages: LiNk-NY/Rnw2Rmd
      - name: install Rnw2Rmd 
        run: Rscript -e "BiocManager::install('LiNk-NY/Rnw2Rmd')"
      - name: convert Rnw
        uses: actions/github-script@v5
        with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
         const fs = require('fs');
         const octokit = github.getOctokit(process.env.GITHUB_TOKEN);

          const files = fs.readdirSync('vignettes');
            for (const file of files) {
            if (file.match(/\.rnw$/i)) {
          try {
            Rnw2Rmd::Rnw2Rmd(from = `vignettes/${file}`, to = `vignettes/${file.replace(/\.rnw$/i, '.Rmd')}`, validate = FALSE);
          } catch (error) {
            const message = `${file} must be converted manually.`;
            const commentBody = `::error::${message}`;
            const issueComment = await octokit.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
          }
             }
           }



      - name: git add
        run: |
          git config --global --add safe.directory /__w/$REPO_NAME/$REPO_NAME
          git config user.name helpful-bot
          git config user.email github-actions@github.com
          git add *.Rmd
          git rm  *.Rnw
          git commit -am "PR autogenerated by Sweave2rmd.yaml"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v4
        with:
          branch: "sweave-conversion"
          title: "Sweave Conversion Changes"

